# 開発タスクリスト

`REQUIREMENT.md` の実現計画に基づき、主要な開発タスクをリストアップします。

## フェーズ1: バックエンド構築 (Firebase)

-   [x] Firebaseプロジェクト作成と設定
    -   [x] プロジェクト作成
    -   [x] Blazeプラン有効化
    -   [x] Firestoreデータベース作成
    -   [x] Firebase CLI初期化（Firestore, Functions, Emulators）
-   [x] Firestoreコレクション設計とセキュリティルール設定
    -   [x] `mappings` コレクション設計・ルール設定
    -   [x] `notes` コレクション設計・ルール設定
-   [x] Cloud Functions実装 (`functions/`)
    -   [x] 開発環境セットアップ (TypeScript, npm, Firebase CLI)
    -   [x] `lineWebhook` 関数の実装
        -   [x] LINE SDK (`@line/bot-sdk`) 導入
        -   [x] 署名検証ロジック実装
        -   [x] `#登録` メッセージ処理 (Firestore `mappings` 書き込み)
        -   [x] テキストメモ保存処理 (Firestore `notes` 書き込み)
        -   [x] エラーハンドリングとロギング
    -   [x] `syncNotes` 関数の実装
        -   [x] Bearerトークン認証ロジック実装
        -   [x] `mappings` から `lineUserId` 取得ロジック
        -   [x] `notes` から未同期メモ取得クエリ (sinceパラメータ対応)
        -   [x] JSONレスポンス生成
        -   [x] 同期後処理 (`synced` 更新 or 削除)
        -   [x] エラーハンドリングとロギング
    -   [x] `cleanupSynced` 関数の実装
        -   [x] 定期実行トリガー設定 (HTTP関数として実装)
        -   [x] 古い同期済みメモの削除ロジック
        -   [x] エラーハンドリングとロギング
-   [x] Cloud Functionsデプロイと動作確認
    -   [x] 環境変数設定 (LINEチャネルシークレット等)
    -   [x] 各関数のデプロイ
    -   [x] Postman等でのエンドポイントテスト

## フェーズ2: フロントエンド構築 (Obsidian Plugin)

-   [ ] Obsidianプラグイン開発環境セットアップ (`obsidian-sample-plugin/`)
    -   [ ] テンプレートからの初期化
    -   [ ] 依存関係インストール (npm)
-   [x] 設定画面の実装 (`main.ts`)
    -   [x] API Endpoint URL入力フィールド
    -   [x] Authentication Token入力フィールド (パスワード形式)
    -   [x] Sync Folder Path入力フィールド
    -   [x] Last Sync Timestamp表示 (読み取り専用)
    -   [x] 設定値の保存・読み込みロジック
-   [x] 同期コマンドの実装 (`main.ts`)
    -   [x] コマンドパレットへの登録
    -   [x] 設定画面への「Sync Now」ボタン追加
    -   [x] `syncNotes` API呼び出しロジック (fetch API)
        -   [x] Bearerトークン付与
        -   [x] `since` パラメータ付与 (lastSync利用)
    -   [x] レスポンス解析 (JSON)
    -   [x] メモデータのMarkdownファイル書き込みロジック (Obsidian API `vault.create`)
        -   [x] ファイル名生成ルール
        -   [x] 指定フォルダへの保存
    -   [x] `lastSync` タイムスタンプ更新ロジック
    -   [x] エラーハンドリングとユーザー通知 (Obsidian API `Notice`)
-   [x] プラグインビルドとローカルテスト

## フェーズ2.5: 課題修正 (優先度高)

-   [x] [必須] ファイル名衝突の修正 (ミリ秒やUUID等で一意性を保証 / 関連: `008_core.md` のファイル名生成ルール, `main.ts`)
    -   [ ] 更なる対策: ファイル名衝突検出と自動リナンバリングの実装
    -   [x] UUIDやランダム文字列を組み合わせた完全な一意性保証
-   [x] [必須] Path Traversal 脆弱性の対策 (パス正規化・検証 / 関連: `main.ts`)
    -   [x] 適切なパス正規化ライブラリの使用 (path.normalize相当)
    -   [x] 厳格なパスバリデーション (ホワイトリスト方式)の実装
    -   [ ] サニタイズしたパスの安全性を確認するテスト実装
-   [x] [必須] `lastSync` 更新ロジック修正 (失敗時は更新しない、APIデータ基準のタイムスタンプ使用 / 関連: `main.ts`)
    -   [ ] サーバー・クライアント間のタイムスタンプ齟齬対策検討
    -   [x] 0件同期時の処理に関するユーザーへの通知改善
-   [x] [推奨] APIエラーハンドリング詳細化 (関連: `main.ts`)
    -   [x] HTTP状態コードに応じたエラーメッセージ
    -   [x] ネットワークエラー、タイムアウトの個別ハンドリング
    -   [x] APIレスポンス構造の詳細な検証ロジック
    -   [ ] リトライメカニズム検討
-   [x] [推奨] 個別ノート保存失敗時の通知改善 (関連: `main.ts`)
    -   [x] 詳細なエラーログ出力機能
    -   [x] 失敗したノートの情報表示（タイトルや一部内容）
    -   [x] 保存に失敗したノートのリスト作成と後処理オプション
-   [x] [推奨] 例外処理の強化
    -   [x] フォルダ作成権限エラーの適切な処理
    -   [x] 設定保存失敗時のリカバリーメカニズム
    -   [x] 無効な日付データ処理のバリデーション追加
-   [ ] [任意] セキュリティ: 認証トークンの保存方法検討
    -   [ ] 環境に応じた適切な暗号化方式の検討
    -   [ ] トークンローテーション機能の検討
-   [x] [必須] APIエンドポイント設定画面の改善
    -   [x] エンドポイントURL直接入力をプロジェクトID/短縮コード方式に変更
    -   [x] エンドポイント自動構築機能の実装
    -   [x] LINE登録フロー時に提供する短縮コード生成機能
    -   [x] 短縮コード→エンドポイントURLのマッピングサービス実装

## フェーズ3: テストとドキュメント

-   [ ] 統合テスト
    -   [x] LINEメッセージ送信 → Firestore保存 → Obsidian同期 → ファイル生成 の一連の流れを確認
    -   [ ] 境界値テスト（sinceパラメータ、大量データなど）
    -   [ ] エラーケーステスト
-   [x] ドキュメント整備 (`docs/`)
    -   [x] 各ドキュメントの最終確認と更新
    -   [x] README.md の作成 (使い方、セットアップ手順など)
    -   [x] テスト計画書の作成 (テスト手順と結果記録用)
-   [ ] (任意) Community Store申請準備

## フェーズ4: その他

-   [ ] コードリファクタリング
-   [ ] パフォーマンスチューニング (必要に応じて)
-   [x] クリーンアップ機能の強化
    -   [x] LINE登録時の古いマッピング削除機能追加
    -   [x] 古い接続コードクリーンアップ機能追加
    -   [ ] クリーンアップジョブの定期実行設定（Cloud Scheduler）

## フェーズ5: Firebase Functions V2への移行

-   [x] 準備作業
    -   [x] V2コード実装 (`indexV2.ts`)
    -   [x] ドキュメント整備 (`firebase_v2_migration.md`)
    -   [x] デプロイスクリプト作成 (`deploy-v2.sh`)
-   [x] テスト
    -   [x] ローカルエミュレーターでのV2関数テスト
    -   [x] シークレット環境変数設定
    -   [x] V2関数のデプロイテスト
-   [x] 段階的移行
    -   [x] `lineWebhookV2`の検証と安定性確認
    -   [x] `syncNotesV2`の検証と安定性確認
    -   [x] `cleanupSyncedV2`の検証と安定性確認
    -   [x] `resolveEndpointV2`の検証と安定性確認
-   [x] クライアント側の対応
    -   [x] Obsidianプラグインのエンドポイント更新
    -   [x] 新エンドポイントでのテスト
-   [x] 完全移行
    -   [x] V1関数の廃止とクリーンアップ
    -   [x] V2関数のリネーム（V2サフィックス削除）
