# API仕様

このシステムで提供されるAPIエンドポイントについて記述します。

## 1. LINE Webhook (`lineWebhook`)

- **トリガー:** HTTP (POSTリクエスト)
- **エンドポイント:** Firebase Cloud Functionsで生成されるURL
- **目的:** LINEプラットフォームからのWebhookイベントを受信し、処理します。
- **主な処理:**
    - **署名検証:** リクエストヘッダーの `X-Line-Signature` を使用して、LINEプラットフォームからの正当なリクエストであることを検証します（`@line/bot-sdk` を利用）。
    - **ユーザー登録:** 受信したメッセージが `"#登録 <トークン>"` 形式の場合、`mappings` コレクションに `{token: lineUserId}` のマッピング情報を保存または更新します。
    - **メモ保存:** 受信したメッセージが通常のテキストの場合、`notes/{lineUserId}/items` コレクションに新しいメモドキュメントを作成します。
        - `content`: メッセージ本文
        - `created`: Firestoreのサーバータイムスタンプ
        - `synced`: `false` (初期値)
- **認証:** LINE署名検証。

## 2. 同期API (`syncNotes`)

- **トリガー:** HTTP (GETリクエスト)
- **エンドポイント:** Firebase Cloud Functionsで生成されるURL
- **パス:** `/syncNotes` (例)
- **クエリパラメータ:**
    - `token`: 必須。Obsidianプラグインで設定された認証トークン。
    - `since`: オプショナル。指定されたタイムスタンプ以降に作成されたメモのみを取得するためのUnixタイムスタンプ（ミリ秒）。指定がない場合は全ての未同期メモを取得。
- **目的:** Obsidianプラグインからのリクエストに応じて、未同期のメモを提供します。
- **主な処理:**
    - **認証:** リクエストヘッダーの `Authorization: Bearer <token>` を検証します。
    - **ユーザー特定:** 提供された `token` を使用して `mappings` コレクションを検索し、対応する `lineUserId` を取得します。
    - **メモ取得:** 特定された `lineUserId` に紐づく `notes` コレクションから、以下の条件を満たすメモを取得します。
        - `synced == false`
        - `created > since` (sinceパラメータが指定されている場合)
    - **レスポンス:** 取得したメモのリスト（`noteId`, `content`, `created` などを含む）をJSON形式で返却します。
    - **同期後処理:** レスポンス送信後、取得対象となったメモの `synced` フラグを `true` に更新するか、ドキュメントを削除します（要件定義に基づく）。
- **認証:** Bearerトークン認証。

## 3. 同期済みメモクリーンアップ (`cleanupSynced`)

- **トリガー:** Cloud Scheduler (onSchedule)
- **目的:** 定期的にFirestore内の同期済み (`synced == true`) かつ古いメモを削除し、データベースを整理します。
- **主な処理:**
    - 全ての `notes` コレクションを走査します。
    - `synced == true` であり、かつ `created` が一定期間（例: 30日前）より古いドキュメントを一括で削除します。
- **認証:** Firebase内部実行（サービスアカウント）。