# データベース設計 (Firestore)

このプロジェクトでは、データストアとしてFirebase Firestoreを使用します。以下にコレクションとドキュメントの構造を示します。

## 1. `mappings` コレクション

- **目的:** LINEユーザーIDとObsidianプラグインの認証トークンを紐付けます。
- **パス:** `mappings/{token}`
- **ドキュメントID (`{token}`):** Obsidianプラグインで発行・設定される一意の認証トークン。
- **フィールド:**
    - `lineUserId`: (string) 対応するLINEユーザーの一意なID。

**例:**
```json
// mappings/user_specific_token_abc123
{
  "lineUserId": "U1234567890abcdef1234567890abcdef"
}
```

## 2. `notes` コレクション (サブコレクション)

- **目的:** 各LINEユーザーが送信したメモを保存します。
- **パス:** `notes/{lineUserId}/items/{noteId}`
- **ドキュメントID (`{noteId}`):** Firestoreによって自動生成される一意のID。
- **フィールド:**
    - `content`: (string) LINEから送信されたメモの本文。
    - `created`: (Timestamp) メモがFirestoreに保存された日時（サーバータイムスタンプ）。同期APIの `since` パラメータで使用されます。
    - `synced`: (boolean) Obsidianプラグインによって同期済みかどうかを示すフラグ。初期値は `false`。
    - `tags`: (string[]) 将来的なタグ機能のためのフィールド（現在は未使用）。

**例:**
```json
// notes/U1234567890abcdef1234567890abcdef/items/autoGeneratedId1
{
  "content": "今日のアイデア：新しいブログ記事の構成",
  "created": Timestamp(seconds=1678886400, nanoseconds=0),
  "synced": false,
  "tags": []
}
```

## 3. `connection_codes` コレクション

- **目的:** 短縮接続コードとAPIエンドポイント情報を紐付けます。
- **パス:** `connection_codes/{code}`
- **ドキュメントID (`{code}`):** システムが生成した短い英数字の接続コード。
- **フィールド:**
    - `endpoint`: (string) APIエンドポイントの完全なURL。
    - `projectId`: (string) 関連するFirebaseプロジェクトのID。
    - `projectName`: (string) ユーザーに表示するプロジェクト名。
    - `created`: (Timestamp) コードが生成された日時。
    - `expires`: (Timestamp, オプション) コードの有効期限（設定する場合）。
    - `usageCount`: (number) コードが使用された回数。

**例:**
```json
// connection_codes/ABC123
{
  "endpoint": "https://us-central1-line-obsidian-notes-sync.cloudfunctions.net/syncNotes",
  "projectId": "line-obsidian-notes-sync",
  "projectName": "LINE to Obsidian Sync",
  "created": Timestamp(seconds=1678886400, nanoseconds=0),
  "expires": Timestamp(seconds=1710422400, nanoseconds=0),
  "usageCount": 3
}
```

## セキュリティルール

Firestoreのセキュリティルールを設定し、不正なアクセスを防ぐ必要があります。

- `mappings` コレクション:
    - Cloud Functions (サービスアカウント) のみが読み書き可能。
- `notes` コレクション:
    - `lineWebhook` 関数 (サービスアカウント) が書き込み可能。
    - `syncNotes` 関数 (サービスアカウント、トークン検証後) が読み取り、更新（`synced` フラグ）、削除が可能。
    - `cleanupSynced` 関数 (サービスアカウント) が削除可能。